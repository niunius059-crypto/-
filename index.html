<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>泡面铺后台 - 管理订单</title>
<style>
  :root{
    --bg:#0f172a;
    --panel:#1e293b;
    --panel2:#334155;
    --text:#f8fafc;
    --text-dim:#94a3b8;
    --accent:#facc15;
    --accent-bg:rgba(250,204,21,.12);
    --radius-lg:16px;
    --radius-sm:8px;
    --border:rgba(255,255,255,.08);
    --shadow:0 30px 60px rgba(0,0,0,.8);
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Inter,system-ui,sans-serif;
  }
  body{
    margin:0;
    background:radial-gradient(circle at 20% 20%,rgba(250,204,21,.2) 0%,transparent 60%),radial-gradient(circle at 80% 0%,rgba(14,165,233,.25) 0%,transparent 60%),linear-gradient(160deg,#0f172a 0%,#1e293b 100%);
    color:var(--text);
    min-height:100vh;
    padding:1rem;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  header{
    width:100%;
    max-width:700px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow);
    padding:1rem 1.2rem;
  }
  h1{
    margin:.2rem 0 .6rem;
    font-size:1.1rem;
    font-weight:600;
    color:var(--text);
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .sub{
    font-size:.75rem;
    color:var(--text-dim);
    line-height:1.4;
  }

  .filter-row{
    margin-top:.75rem;
    display:flex;
    flex-wrap:wrap;
    gap:.5rem;
  }
  select,button{
    background:var(--panel2);
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    color:var(--text);
    font-size:.8rem;
    padding:.5rem .6rem;
    cursor:pointer;
  }
  button.accent{
    background:var(--accent-bg);
    border:1px solid var(--accent);
    color:var(--accent);
    font-weight:600;
  }

  .list{
    margin-top:1rem;
    width:100%;
    max-width:700px;
  }

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow);
    padding:1rem 1.2rem;
    font-size:.8rem;
    line-height:1.5;
    margin-bottom:1rem;
    position:relative;
  }

  .row1{
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:.5rem;
    font-size:.8rem;
    line-height:1.4;
  }
  .badge{
    background:var(--accent-bg);
    border:1px solid var(--accent);
    border-radius:var(--radius-sm);
    color:var(--accent);
    font-size:.7rem;
    font-weight:600;
    padding:.2rem .4rem;
    line-height:1.2;
  }
  .muted{
    color:var(--text-dim);
    font-size:.7rem;
  }
  .strong{
    font-weight:600;
    color:var(--text);
  }
  .pair{
    margin-top:.4rem;
  }
  .pair span{
    display:inline-block;
    min-width:4em;
    color:var(--text-dim);
  }

  .ctrl-row{
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
    margin-top:.75rem;
  }
  .ctrl-row select{
    flex:1;
  }
  .ctrl-row button{
    flex:1;
  }
</style>
</head>
<body>

<header>
  <h1>
    <span>🍜 泡面铺后台</span>
    <span style="font-size:.8rem;font-weight:400;color:var(--accent);">仅老板查看</span>
  </h1>
  <div class="sub">
    查看所有未完成的订单，更新派送状态。<br/>
    状态含义：待确认 / 已接受 / 送面中 / 已送达 / 取消
  </div>

  <div class="filter-row">
    <select id="statusFilter">
      <option value="all">全部订单</option>
      <option value="active">只看未送达</option>
      <option value="todo">只看待确认</option>
    </select>
    <button class="accent" onclick="clearDelivered()">隐藏所有已送达(不会删数据)</button>
    <button onclick="exportData()">导出JSON备份</button>
  </div>
</header>

<section class="list" id="orderList">
  <!-- 订单卡片会用JS插进去 -->
</section>

<script>
  // 读本地订单
  function loadOrders(){
    const raw = localStorage.getItem('noodleOrders');
    let list = [];
    if(raw){
      try{ list = JSON.parse(raw); }catch(e){ list = []; }
    }
    // 最新的排最上面
    list.sort((a,b)=> (b.createdAtTs||0) - (a.createdAtTs||0));
    return list;
  }

  function saveOrders(list){
    localStorage.setItem('noodleOrders', JSON.stringify(list));
  }

  function updateStatus(orderId, newStatus){
    const list = loadOrders();
    const idx = list.findIndex(o=>o.id===orderId);
    if(idx>=0){
      list[idx].status = newStatus;
      saveOrders(list);
      render();
    }
  }

  function clearDelivered(){
    // 把已送达的打个标记 hidden=true，这样还在本地但前端默认不显示
    const list = loadOrders();
    list.forEach(o=>{
      if(o.status==="已送达") o.hidden = true;
    });
    saveOrders(list);
    render();
  }

  function exportData(){
    const list = loadOrders();
    const blob = new Blob([JSON.stringify(list,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = "noodleOrders-"+now+".json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function render(){
    const wrap = document.getElementById('orderList');
    wrap.innerHTML = "";

    const filter = document.getElementById('statusFilter').value;
    const list = loadOrders();

    list.forEach(order=>{
      if(order.hidden) return;

      // 过滤器逻辑
      if(filter==="active" && (order.status==="已送达" || order.status==="取消")) return;
      if(filter==="todo" && order.status!=="待确认") return;

      const card = document.createElement('div');
      card.className = "card";

      const row1 = document.createElement('div');
      row1.className = "row1";

      const leftInfo = document.createElement('div');
      leftInfo.innerHTML = `
        <div class="strong">${order.noodle} <span style="color:#facc15;">¥${order.price}</span></div>
        <div class="muted">订单ID：${order.id}</div>
        <div class="muted">下单时间：${order.createdAt || ''}</div>
      `;

      const rightInfo = document.createElement('div');
      rightInfo.innerHTML = `<div class="badge">${order.status}</div>`;

      row1.appendChild(leftInfo);
      row1.appendChild(rightInfo);

      const detail = document.createElement('div');
      detail.innerHTML = `
        <div class="pair"><span>宿舍</span>${order.building} ${order.room}</div>
        <div class="pair"><span>备注</span>${order.note || "（无）"}</div>
        <div class="pair"><span>时间</span>${order.timeSlot}</div>
        <div class="pair"><span>联系</span>${order.contact}</div>
      `;

      const ctrl = document.createElement('div');
      ctrl.className = "ctrl-row";

      const sel = document.createElement('select');
      ["待确认","已接受","送面中","已送达","取消"].forEach(s=>{
        const op = document.createElement('option');
        op.value = s;
        op.textContent = s;
        if(order.status===s) op.selected = true;
        sel.appendChild(op);
      });

      const btn = document.createElement('button');
      btn.textContent = "更新状态";
      btn.onclick = ()=>{
        updateStatus(order.id, sel.value);
      };

      ctrl.appendChild(sel);
      ctrl.appendChild(btn);

      card.appendChild(row1);
      card.appendChild(detail);
      card.appendChild(ctrl);

      wrap.appendChild(card);
    });
  }

  // 首次初始化：如果老订单里没有时间戳，加上时间戳
  (function normalize(){
    const list = loadOrders();
    let changed = false;
    list.forEach(o=>{
      if(!o.createdAtTs){
        o.createdAtTs = Date.now();
        changed = true;
      }
    });
    if(changed){
      saveOrders(list);
    }
  })();

  // 监听筛选器
  document.getElementById('statusFilter').addEventListener('change', render);

  // 渲染页面
  render();
</script>
</body>
</html>
